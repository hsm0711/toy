<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout}">
<head>
    <title>AI vs AI í† ë¡  ë°°í‹€</title>
    <th:block layout:fragment="extra-css">
        <link rel="stylesheet" th:href="@{/css/tool-page.css}">
        <link rel="stylesheet" th:href="@{/css/components.css}">
        <style>
            .debate-container {
                display: flex;
                flex-direction: column;
                gap: 1.5rem;
                margin-top: 1rem;
            }
            .debate-input-section {
                display: flex;
                gap: 1rem;
                align-items: center;
            }
            textarea.form-control {
                flex-grow: 1;
                resize: vertical;
                font-size: 0.95rem;
                min-height: 80px;
                max-height: 200px;
            }
            .debate-log {
                background-color: #f8f9fa;
                border: 1px solid #e2e8f0;
                border-radius: 8px;
                padding: 1rem;
                min-height: 300px;
                max-height: 600px;
                overflow-y: auto;
                font-size: 0.9rem;
                line-height: 1.6;
            }
            .debate-message {
                margin-bottom: 0.8rem;
                padding: 0.6rem 1rem;
                border-radius: 6px;
                word-break: break-word; /* ê¸´ ë‹¨ì–´/ë¬¸ìì—´ì´ ë ˆì´ì•„ì›ƒì„ ê¹¨ì§€ ì•Šë„ë¡ */
            }
            .debate-message.ai1 {
                background-color: #e6f7ff; /* Light blue */
                text-align: left;
            }
            .debate-message.ai2 {
                background-color: #fff0f6; /* Light pink */
                text-align: right;
            }
            .debate-message strong {
                display: block;
                margin-bottom: 0.3rem;
                font-size: 1rem;
            }
            .streaming-indicator {
                display: none;
                align-items: center;
                gap: 0.5rem;
                color: #667eea;
                font-weight: 500;
                margin-top: 1rem;
            }
            .streaming-indicator.show {
                display: flex;
            }
            .streaming-dot {
                width: 8px;
                height: 8px;
                background: #667eea;
                border-radius: 50%;
                animation: pulse 1.5s infinite;
            }
            @keyframes pulse {
                0%, 100% { opacity: 1; }
                50% { opacity: 0.3; }
            }
            .error-message {
                color: #dc3545;
                font-weight: bold;
                margin-top: 0.5rem;
            }
        </style>
    </th:block>
</head>
<body>
<div layout:fragment="content">
    <div class="tool-container">
        <div class="page-header">
            <h2>ğŸ¤– AI vs AI í† ë¡  ë°°í‹€</h2>
            <p class="description">ë‘ AI ëª¨ë¸ì´ íŠ¹ì • ì£¼ì œì— ëŒ€í•´ í† ë¡ í•˜ëŠ” ê³¼ì •ì„ ì§€ì¼œë´…ë‹ˆë‹¤.</p>
        </div>

        <div class="tool-section card">
            <div class="debate-container">
                <div class="debate-input-section">
                    <textarea id="debateTopic" class="form-control" placeholder="AIë“¤ì˜ í‚¤ë³´ë“œ ì›Œë¦¬ì–´ë¥¼ ê¹¨ìš¸ ì£¼ì œë¥¼ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: ë¶•ì–´ë¹µì—ëŠ” ë¶•ì–´ê°€ ìˆë‹¤?)..."></textarea>
                    <div style="width: 120px;">
                        <label for="debateTurns" class="form-label visually-hidden">í† ë¡  í„´ ìˆ˜</label>
                        <select id="debateTurns" class="form-select">
                            <option value="3">3 í„´</option>
                            <option value="5" selected>5 í„´</option>
                            <option value="7">7 í„´</option>
                            <option value="10">10 í„´</option>
                        </select>
                    </div>
                    <button class="btn btn-primary" onclick="startDebate()" id="startDebateBtn">
                        âš”ï¸ AI ëŒ€ì „ ì‹œì‘!
                    </button>
                </div>
                
                <div class="streaming-indicator" id="streamingIndicator">
                    <div class="streaming-dot"></div>
                    <span>AIë“¤ì˜ ë…¼ë¦¬ íšŒë¡œ í’€ê°€ë™ ì¤‘... ì§€ê¸ˆ, ì—­ì‚¬ì ì¸(?) ë…¼ìŸì´ í¼ì³ì§‘ë‹ˆë‹¤!</span>
                </div>

                <div id="debateLog" class="debate-log">
                    <!-- Debate messages will be inserted here -->
                    <p>AIë“¤ì˜ ë¶ˆê½ƒ íŠ€ëŠ” ë…¼ìŸì„ ë³´ì‹œë ¤ë©´, ì£¼ì œë¥¼ ì…ë ¥í•˜ê³  'AI ëŒ€ì „ ì‹œì‘!' ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.</p>
                </div>
                
                <div id="errorMessage" class="error-message"></div>
            </div>
        </div>
    </div>
</div>

<th:block layout:fragment="extra-js">
    <script th:src="@{/js/common-utils.js}"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.6.1/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    <script>
        let stompClient = null;
        let currentSessionId = null;

        function connect(sessionId) {
            const socket = new SockJS('/ws'); // WebSocketConfigì—ì„œ ì„¤ì •í•œ ì—”ë“œí¬ì¸íŠ¸
            stompClient = Stomp.over(socket);
            stompClient.connect({}, function (frame) {
                console.log('Connected: ' + frame);
                currentSessionId = sessionId;
                // ì„¸ì…˜ IDì— í•´ë‹¹í•˜ëŠ” í† í”½ì„ êµ¬ë…
                stompClient.subscribe('/topic/ai-debate-updates/' + sessionId, function (message) {
                    const debateUpdate = JSON.parse(message.body);
                    console.log('Received: ', debateUpdate);
                    addDebateMessage(debateUpdate.speaker, debateUpdate.message, debateUpdate.speaker === "AI 1");

                    if (debateUpdate.isCompleted) {
                        disconnect();
                        UiUtils.showSuccess('ë“œë””ì–´ ê²°ë¡ ! AIë“¤ì˜ ì‹¸ì›€, ì¸ê°„ë§Œ êµ¬ê²½...');
                        document.getElementById('startDebateBtn').disabled = false;
                        document.getElementById('startDebateBtn').innerHTML = 'âš”ï¸ AI ëŒ€ì „ ì‹œì‘!';
                        document.getElementById('streamingIndicator').classList.remove('show');
                    }
                });
                console.log('Subscribed to /topic/ai-debate-updates/' + sessionId);

                // ì—°ê²° í›„ í† ë¡  ì‹œì‘ ë©”ì‹œì§€ ì „ì†¡
                const topic = document.getElementById('debateTopic').value.trim();
                const turns = document.getElementById('debateTurns').value;
                stompClient.send("/app/ai-debate/start", {}, JSON.stringify({ 'topic': topic, 'turns': turns, 'sessionId': sessionId }));
                console.log('Sent start debate message via STOMP.');

            }, function (error) {
                console.error('STOMP Error:', error);
                UiUtils.showError('WebSocket ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                document.getElementById('startDebateBtn').disabled = false;
                document.getElementById('startDebateBtn').innerHTML = 'âš”ï¸ AI ëŒ€ì „ ì‹œì‘!';
                document.getElementById('streamingIndicator').classList.remove('show');
            });
        }

        function disconnect() {
            if (stompClient !== null) {
                stompClient.disconnect();
                stompClient = null;
                console.log("Disconnected");
            }
        }

        async function startDebate() {
            if (stompClient && stompClient.connected) {
                UiUtils.showError('ì´ë¯¸ í† ë¡ ì´ ì§„í–‰ ì¤‘ì…ë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                return;
            }

            const topic = document.getElementById('debateTopic').value.trim();
            const turns = document.getElementById('debateTurns').value;

            if (!topic) {
                UiUtils.showError('í† ë¡  ì£¼ì œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            const startDebateBtn = document.getElementById('startDebateBtn');
            const streamingIndicator = document.getElementById('streamingIndicator');
            const debateLog = document.getElementById('debateLog');

            debateLog.innerHTML = '<p>AIë“¤ì˜ ì‹¬ì¥ì„ ê¹¨ìš°ëŠ” ì¤‘...</p>'; // Clear previous debate and show starting message
            UiUtils.hideError();
            startDebateBtn.disabled = true;
            startDebateBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> AIë“¤, ë°ì´í„° ë¹¨ì•„ë“¤ì´ëŠ” ì¤‘...';
            streamingIndicator.classList.add('show');

            try {
                // HTTP POST ìš”ì²­ì„ ë³´ë‚´ ì„¸ì…˜ IDë¥¼ ë°›ì•„ì˜´
                const response = await fetch('/ai-debate/api/start-debate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ topic: topic, turns: turns }),
                });

                const data = await response.json();

                if (response.ok && data.success && data.sessionId) {
                    debateLog.innerHTML = ''; // Clear initial message once session ID is received
                    connect(data.sessionId); // ì„¸ì…˜ IDë¥¼ ì‚¬ìš©í•˜ì—¬ WebSocket ì—°ê²° ë° êµ¬ë…
                } else {
                    UiUtils.showError(data.message || 'í† ë¡  ì‹œì‘ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                    startDebateBtn.disabled = false;
                    startDebateBtn.innerHTML = 'âš”ï¸ AI ëŒ€ì „ ì‹œì‘!';
                    streamingIndicator.classList.remove('show');
                }
            } catch (error) {
                console.error('API ì˜¤ë¥˜:', error);
                UiUtils.showError('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ ë˜ëŠ” ì„œë²„ ë¬¸ì œ ë°œìƒ');
                startDebateBtn.disabled = false;
                startDebateBtn.innerHTML = 'âš”ï¸ AI ëŒ€ì „ ì‹œì‘!';
                streamingIndicator.classList.remove('show');
            }
        }
        
        function addDebateMessage(sender, message, isAI1) {
            const debateLog = document.getElementById('debateLog');
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('debate-message');
            // 'System' ë©”ì‹œì§€ëŠ” AI1/AI2 ìŠ¤íƒ€ì¼ì„ ì ìš©í•˜ì§€ ì•ŠìŒ
            if (sender === "AI 1") {
                messageDiv.classList.add('ai1');
            } else if (sender === "AI 2") {
                messageDiv.classList.add('ai2');
            }
            
            // System ë©”ì‹œì§€ì˜ ê²½ìš° êµµê²Œ í‘œì‹œí•˜ì§€ ì•Šê³  ì¤‘ì•™ ì •ë ¬
            if (sender === "System") {
                messageDiv.style.textAlign = 'center';
                messageDiv.innerHTML = `<em>${message}</em>`;
            } else {
                messageDiv.innerHTML = `<strong>${sender}:</strong> ${message}`;
            }
            
            debateLog.appendChild(messageDiv);
            debateLog.scrollTop = debateLog.scrollHeight; // Scroll to bottom
        }

        // í˜ì´ì§€ë¥¼ ë– ë‚  ë•Œ WebSocket ì—°ê²°ì„ ëŠìŠµë‹ˆë‹¤.
        window.onbeforeunload = function() {
            disconnect();
        };
    </script>
</th:block>
</body>
</html>
