<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title layout:title-pattern="$CONTENT_TITLE - $LAYOUT_TITLE">Playground</title>
    
    <!-- 공통 CSS -->
    <link rel="stylesheet" th:href="@{/css/common.css}">
    
    <!-- 페이지별 CSS -->
    <th:block layout:fragment="extra-css"></th:block>
    <link rel="icon" type="image/svg+xml" th:href="@{/image/favicon.svg}">
</head>
<body>
    <!-- 모바일 메뉴 오버레이 -->
    <div class="overlay" id="menuOverlay"></div>

    <!-- 네비게이션 바 (공통) -->
    <nav class="navbar" th:fragment="navbar">
        <div class="container">
            <!-- 로고 영역 -->
            <div class="logo">
                <a th:href="@{/}" aria-label="홈으로 가기">Playground</a>
            </div>
            
            <!-- 햄버거 메뉴 버튼 (모바일) -->
            <button class="menu-toggle" id="menuToggle" aria-label="메뉴 열기" aria-expanded="false">
                <span></span>
                <span></span>
                <span></span>
            </button>
            
            <!-- 메뉴 리스트 (개선) -->
            <ul class="nav-menu" id="navMenu" role="navigation">
                <th:block th:each="menu, iterStat : ${menus}">
                    <li th:if="${iterStat.index < 4}">
                        <a th:href="@{${menu.path}}"
                           th:text="${menu.name}"
                           th:classappend="${(menu.path == '/' && currentPage == 'home') || (menu.path.length() > 1 && currentPage == menu.path.substring(1))} ? 'active' : ''"
                           th:attr="aria-current=${(menu.path == '/' && currentPage == 'home') || (menu.path.length() > 1 && currentPage == menu.path.substring(1))} ? 'page' : null">
                        </a>
                    </li>
                </th:block>

                <li class="dropdown" th:if="${#lists.size(menus) > 4}">
                    <a href="#" class="dropdown-toggle" id="moreMenuLink" aria-haspopup="true" aria-expanded="false"
                       th:classappend="${!#lists.isEmpty(#lists.select(menus.subList(4, #lists.size(menus)), m -> { m.path == '/' ? (currentPage == 'home') : (currentPage == m.path.substring(1)) })) ? 'active' : ''}">
                        더보기 <span class="arrow-down"></span>
                    </a>
                    <ul class="dropdown-menu" id="moreMenuDropdown" aria-labelledby="moreMenuLink">
                        <th:block th:each="menu, iterStat : ${menus}">
                            <li th:if="${iterStat.index >= 4}">
                                <a th:href="@{${menu.path}}"
                                   th:text="${menu.name}"
                                   th:classappend="${(menu.path.length() > 1 && currentPage == menu.path.substring(1))} ? 'active' : ''"
                                   th:attr="aria-current=${(menu.path.length() > 1 && currentPage == menu.path.substring(1))} ? 'page' : null">
                                </a>
                            </li>
                        </th:block>
                    </ul>
                </li>
            </ul>
        </div>
    </nav>

    <!-- 메인 컨텐츠 영역 -->
    <main class="container" role="main">
        <div layout:fragment="content">
            <!-- 페이지별 컨텐츠가 여기에 삽입됩니다 -->
        </div>
    </main>

    <!-- 푸터 (공통) -->
    <footer th:fragment="footer" role="contentinfo">
        <div class="container">
            <p>&copy; <span th:text="${#dates.year(#dates.createNow())}">2024</span> Playground. All rights reserved.</p>
        </div>
    </footer>

    <!-- 공통 JavaScript -->
    <script>
        // 모바일 메뉴 토글 기능
        document.addEventListener('DOMContentLoaded', function() {
            const menuToggle = document.getElementById('menuToggle');
            const navMenu = document.getElementById('navMenu');
            const menuOverlay = document.getElementById('menuOverlay');
            const body = document.body;
            
            if (menuToggle && navMenu && menuOverlay) {
                // 메뉴 토글 버튼 클릭
                menuToggle.addEventListener('click', function(e) {
                    e.stopPropagation();
                    toggleMenu();
                });
                
                // 오버레이 클릭 시 메뉴 닫기
                menuOverlay.addEventListener('click', function() {
                    closeMenu();
                });
                
                // 메뉴 링크 클릭 시 메뉴 닫기 (모바일)
                const menuLinks = navMenu.querySelectorAll('a');
                menuLinks.forEach(link => {
                    link.addEventListener('click', function() {
                        if (window.innerWidth <= 768) {
                            closeMenu();
                        }
                    });
                });
                
                // ESC 키로 메뉴 닫기
                document.addEventListener('keydown', function(e) {
                    if (e.key === 'Escape' && navMenu.classList.contains('active')) {
                        closeMenu();
                    }
                });
                
                // 윈도우 리사이즈 시 메뉴 상태 초기화
                let resizeTimer;
                window.addEventListener('resize', function() {
                    clearTimeout(resizeTimer);
                    resizeTimer = setTimeout(function() {
                        if (window.innerWidth > 768) {
                            closeMenu();
                        }
                    }, 250);
                });
            }
            
            function toggleMenu() {
                const isActive = menuToggle.classList.contains('active');
                
                if (isActive) {
                    closeMenu();
                } else {
                    openMenu();
                }
            }
            
            function openMenu() {
                menuToggle.classList.add('active');
                navMenu.classList.add('active');
                menuOverlay.classList.add('active');
                body.style.overflow = 'hidden';
                menuToggle.setAttribute('aria-expanded', 'true');
                menuToggle.setAttribute('aria-label', '메뉴 닫기');
            }
            
            function closeMenu() {
                menuToggle.classList.remove('active');
                navMenu.classList.remove('active');
                menuOverlay.classList.remove('active');
                body.style.overflow = '';
                menuToggle.setAttribute('aria-expanded', 'false');
                menuToggle.setAttribute('aria-label', '메뉴 열기');
            }
        });
        
        // "더보기" 드롭다운 메뉴 기능
        document.addEventListener('DOMContentLoaded', function() {
            const moreMenuLink = document.getElementById('moreMenuLink');
            const moreMenuDropdown = document.getElementById('moreMenuDropdown');

            if (moreMenuLink && moreMenuDropdown) {
                moreMenuLink.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    // 모바일 뷰에서는 일반 링크처럼 동작하지 않도록 함
                    if (window.innerWidth > 768) {
                        this.parentElement.classList.toggle('show');
                        const isExpanded = this.parentElement.classList.contains('show');
                        this.setAttribute('aria-expanded', isExpanded);
                    }
                });

                // 페이지 다른 곳 클릭 시 드롭다운 닫기
                document.addEventListener('click', function(e) {
                    if (!moreMenuLink.contains(e.target)) {
                        const dropdown = moreMenuLink.parentElement;
                        if (dropdown.classList.contains('show')) {
                            dropdown.classList.remove('show');
                            moreMenuLink.setAttribute('aria-expanded', 'false');
                        }
                    }
                });
            }
        });

        // 스크롤 시 네비게이션 바 그림자 효과
        let lastScrollTop = 0;
        window.addEventListener('scroll', function() {
            const navbar = document.querySelector('.navbar');
            const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
            
            if (navbar) {
                if (scrollTop > 10) {
                    navbar.style.boxShadow = '0 4px 12px rgba(0, 0, 0, 0.15)';
                } else {
                    navbar.style.boxShadow = '0 4px 6px rgba(0, 0, 0, 0.1)';
                }
            }
            
            lastScrollTop = scrollTop;
        }, { passive: true });
        
        // 메뉴 항목에 키보드 네비게이션 지원
        document.addEventListener('DOMContentLoaded', function() {
            const menuItems = document.querySelectorAll('.nav-menu a');
            
            menuItems.forEach((item, index) => {
                item.addEventListener('keydown', function(e) {
                    let nextItem;
                    
                    switch(e.key) {
                        case 'ArrowRight':
                        case 'ArrowDown':
                            e.preventDefault();
                            nextItem = menuItems[index + 1] || menuItems[0];
                            nextItem.focus();
                            break;
                        case 'ArrowLeft':
                        case 'ArrowUp':
                            e.preventDefault();
                            nextItem = menuItems[index - 1] || menuItems[menuItems.length - 1];
                            nextItem.focus();
                            break;
                        case 'Home':
                            e.preventDefault();
                            menuItems[0].focus();
                            break;
                        case 'End':
                            e.preventDefault();
                            menuItems[menuItems.length - 1].focus();
                            break;
                    }
                });
            });
        });
    </script>
    
    <th:block layout:fragment="extra-js"></th:block>
</body>
</html>