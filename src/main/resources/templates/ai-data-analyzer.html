<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout}">
<head>
    <title>AI ë°ì´í„° ë¶„ì„</title>
    <th:block layout:fragment="extra-css">
        <link rel="stylesheet" th:href="@{/css/tool-page.css}">
        <link rel="stylesheet" th:href="@{/css/components.css}">
        <style>
            .data-preview {
                background: #f8f9fa;
                padding: 1rem;
                border-radius: 8px;
                max-height: 300px;
                overflow: auto;
                font-family: 'Courier New', monospace;
                font-size: 0.85rem;
                margin-top: 1rem;
                display: none;
            }
            
            .data-preview.show {
                display: block;
            }
            
            .data-preview table {
                width: 100%;
                border-collapse: collapse;
            }
            
            .data-preview th,
            .data-preview td {
                padding: 0.5rem;
                border: 1px solid #dee2e6;
                text-align: left;
            }
            
            .data-preview th {
                background: #e9ecef;
                font-weight: 600;
            }
            
            .insight-card {
                background: white;
                padding: 1.5rem;
                border-radius: 10px;
                margin-bottom: 1rem;
                border-left: 4px solid #667eea;
                box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            }
            
            .insight-card h4 {
                color: #2d3748;
                margin-bottom: 0.75rem;
                display: flex;
                align-items: center;
                gap: 0.5rem;
            }
            
            .insight-content {
                color: #4a5568;
                line-height: 1.6;
            }
            
            .file-info {
                background: #e7f3ff;
                padding: 1rem;
                border-radius: 8px;
                margin: 1rem 0;
                display: none;
            }
            
            .file-info.show {
                display: block;
            }
            
            .stats-grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
                gap: 1rem;
                margin: 1rem 0;
            }
            
            .stat-card {
                background: white;
                padding: 1rem;
                border-radius: 8px;
                text-align: center;
                border: 2px solid #e2e8f0;
            }
            
            .stat-number {
                font-size: 2rem;
                font-weight: 700;
                color: #667eea;
            }
            
            .stat-label {
                font-size: 0.85rem;
                color: #6c757d;
                margin-top: 0.25rem;
            }

            .usage-badge {
                display: inline-block;
                padding: 0.5rem 1rem;
                background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
                color: white;
                border-radius: 20px;
                font-size: 0.85rem;
                font-weight: 600;
                margin-bottom: 1rem;
            }
            
            .info-box {
                background: #d1f2eb;
                border-left: 4px solid #28a745;
                padding: 1rem;
                margin: 1rem 0;
                border-radius: 6px;
            }
            
            .streaming-indicator {
                display: none;
                align-items: center;
                gap: 0.5rem;
                color: #667eea;
                font-weight: 500;
                margin-top: 1rem;
            }
            
            .streaming-indicator.show {
                display: flex;
            }
            
            .streaming-dot {
                width: 8px;
                height: 8px;
                background: #667eea;
                border-radius: 50%;
                animation: pulse 1.5s infinite;
            }
            
            @keyframes pulse {
                0%, 100% { opacity: 1; }
                50% { opacity: 0.3; }
            }
        </style>
    </th:block>
</head>
<body>
    <div layout:fragment="content">
        <div class="tool-container">
            <div class="page-header">
                <h2>ğŸ“Š AI ë°ì´í„° ë¶„ì„</h2>
                <p class="description">CSVë‚˜ JSON ë°ì´í„°ë¥¼ ì—…ë¡œë“œí•˜ë©´ AIê°€ ë¶„ì„í•˜ê³  ì¸ì‚¬ì´íŠ¸ë¥¼ ì œê³µí•©ë‹ˆë‹¤.</p>
                <div class="usage-badge">ğŸ¤– ì™„ì „ ë¬´ë£Œ - í†µê³„ ë¶„ì„ ê¸°ë°˜</div>
            </div>

            <div class="info-box">
                <strong>âœ… ì™„ì „ ë¬´ë£Œ:</strong> ë¸Œë¼ìš°ì €ì—ì„œ ì§ì ‘ ì‹¤í–‰ë˜ëŠ” í†µê³„ ë¶„ì„ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.<br>
                <strong>ğŸ“Š ë¶„ì„ í•­ëª©:</strong> ê¸°ë³¸ í†µê³„, ë°ì´í„° ë¶„í¬, ìµœë¹ˆê°’, í‰ê· , ìµœì†Œ/ìµœëŒ€ê°’ ë“±
            </div>

            <div class="tool-section card">
                <h3>ë°ì´í„° ì—…ë¡œë“œ</h3>
                
                <div class="input-group">
                    <label>íŒŒì¼ ì„ íƒ (CSV ë˜ëŠ” JSON)</label>
                    <input type="file" id="fileInput" accept=".csv,.json" onchange="handleFileUpload(event)">
                    <div class="helper-text">ìµœëŒ€ 5MB, CSV ë˜ëŠ” JSON í˜•ì‹</div>
                </div>

                <div class="file-info" id="fileInfo"></div>

                <div class="input-group">
                    <label>ë˜ëŠ” ë°ì´í„° ì§ì ‘ ì…ë ¥ (CSV í˜•ì‹)</label>
                    <textarea id="dataInput" placeholder="name,age,city&#10;Alice,30,Seoul&#10;Bob,25,Busan" style="min-height: 150px; font-family: monospace;"></textarea>
                </div>

                <div class="data-preview" id="dataPreview"></div>

                <div class="button-group">
                    <button class="btn btn-primary" onclick="analyzeData()" id="analyzeBtn">
                        ğŸ“Š AI ë°ì´í„° ë¶„ì„
                    </button>
                    <button class="btn btn-secondary" onclick="clearData()">ğŸ—‘ï¸ ì´ˆê¸°í™”</button>
                </div>

                <div class="streaming-indicator" id="streamingIndicator">
                    <div class="streaming-dot"></div>
                    <span>AIê°€ ë°ì´í„°ë¥¼ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤...</span>
                </div>

                <div id="analysisResults" style="display: none; margin-top: 2rem;">
                    <h3>ë¶„ì„ ê²°ê³¼</h3>
                    <div class="stats-grid" id="statsGrid"></div>
                    <div id="insightsContainer"></div>
                </div>
            </div>

            <div class="examples" style="background: #e7f3ff;">
                <h4 style="color: #004085;">ğŸ’¡ ìƒ˜í”Œ ë°ì´í„° (í´ë¦­í•˜ì—¬ ì…ë ¥)</h4>
                <div class="example-item" onclick="fillSampleData('sales')">
                    ğŸ’° ë§¤ì¶œ ë°ì´í„° ì˜ˆì œ
                </div>
                <div class="example-item" onclick="fillSampleData('students')">
                    ğŸ“ í•™ìƒ ì„±ì  ë°ì´í„°
                </div>
                <div class="example-item" onclick="fillSampleData('products')">
                    ğŸ“¦ ì œí’ˆ ì¬ê³  ë°ì´í„°
                </div>
            </div>
            
            <div id="errorMessage" class="error-message"></div>
        </div>
    </div>

    <th:block layout:fragment="extra-js">
        <script th:src="@{/js/common-utils.js}"></script>
        <script th:src="@{/js/ai-utils.js}"></script>
        
        <script>
            let currentData = null;
            let dataType = null;

            function handleFileUpload(event) {
                const file = event.target.files[0];
                if (!file) return;
                
                if (file.size > 5 * 1024 * 1024) {
                    UiUtils.showError('íŒŒì¼ í¬ê¸°ëŠ” 5MB ì´í•˜ì—¬ì•¼ í•©ë‹ˆë‹¤.');
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    const content = e.target.result;
                    const extension = file.name.split('.').pop().toLowerCase();
                    
                    if (extension === 'csv') {
                        parseCSV(content);
                    } else if (extension === 'json') {
                        parseJSON(content);
                    }
                    
                    const fileInfo = document.getElementById('fileInfo');
                    fileInfo.innerHTML = `
                        <strong>ğŸ“ íŒŒì¼:</strong> ${file.name}<br>
                        <strong>ğŸ“ í¬ê¸°:</strong> ${FormatUtils.formatFileSize(file.size)}<br>
                        <strong>ğŸ“Š í˜•ì‹:</strong> ${extension.toUpperCase()}
                    `;
                    fileInfo.classList.add('show');
                };
                reader.readAsText(file);
            }

            function parseCSV(content) {
                const lines = content.trim().split('\n');
                if (lines.length < 2) {
                    UiUtils.showError('CSV ë°ì´í„°ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                    return;
                }
                
                const headers = lines[0].split(',').map(h => h.trim());
                const rows = lines.slice(1).map(line => {
                    const values = line.split(',').map(v => v.trim());
                    const obj = {};
                    headers.forEach((header, index) => {
                        obj[header] = values[index];
                    });
                    return obj;
                });
                
                currentData = rows;
                dataType = 'csv';
                displayDataPreview(rows, headers);
            }

            function parseJSON(content) {
                try {
                    const data = JSON.parse(content);
                    if (!Array.isArray(data)) {
                        UiUtils.showError('JSONì€ ë°°ì—´ í˜•ì‹ì´ì–´ì•¼ í•©ë‹ˆë‹¤.');
                        return;
                    }
                    
                    currentData = data;
                    dataType = 'json';
                    
                    if (data.length > 0) {
                        const headers = Object.keys(data[0]);
                        displayDataPreview(data, headers);
                    }
                } catch (error) {
                    UiUtils.showError('JSON íŒŒì‹± ì˜¤ë¥˜: ' + error.message);
                }
            }

            function displayDataPreview(data, headers) {
                const preview = document.getElementById('dataPreview');
                const maxRows = Math.min(data.length, 10);
                
                let html = `<strong>ë°ì´í„° ë¯¸ë¦¬ë³´ê¸° (${data.length}ê°œ ì¤‘ ${maxRows}ê°œ)</strong><br><br>`;
                html += '<table>';
                html += '<tr>' + headers.map(h => `<th>${h}</th>`).join('') + '</tr>';
                
                for (let i = 0; i < maxRows; i++) {
                    html += '<tr>';
                    headers.forEach(header => {
                        html += `<td>${data[i][header] || ''}</td>`;
                    });
                    html += '</tr>';
                }
                
                html += '</table>';
                preview.innerHTML = html;
                preview.classList.add('show');
            }

            async function analyzeData() {
                if (!currentData) {
                    const manualInput = document.getElementById('dataInput').value.trim();
                    if (manualInput) {
                        parseCSV(manualInput);
                    }
                }
                
                if (!currentData || currentData.length === 0) {
                    UiUtils.showError('ë¶„ì„í•  ë°ì´í„°ë¥¼ ì—…ë¡œë“œí•˜ê±°ë‚˜ ì…ë ¥í•˜ì„¸ìš”.');
                    return;
                }
                
                const analyzeBtn = document.getElementById('analyzeBtn');
                const streamingIndicator = document.getElementById('streamingIndicator');
                const resultsDiv = document.getElementById('analysisResults');
                
                try {
                    UiUtils.hideError();
                    analyzeBtn.disabled = true;
                    analyzeBtn.textContent = 'â³ ë¶„ì„ ì¤‘...';
                    streamingIndicator.style.display = 'flex';
                    resultsDiv.style.display = 'none';
                    
                    // í†µê³„ ë¶„ì„ ìˆ˜í–‰ (ë¸Œë¼ìš°ì €ì—ì„œ ì§ì ‘ ì‹¤í–‰)
                    const result = window.aiUtils.analyzeData(currentData);

                    if (result.success) {
                        displayBasicStats();
                        displayInsights(result.result);
                        resultsDiv.style.display = 'block';
                        UiUtils.showSuccess('ë°ì´í„° ë¶„ì„ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!');
                    } else {
                        UiUtils.showError(result.message);
                    }
                } catch (error) {
                    console.error('AI ë¶„ì„ ì˜¤ë¥˜:', error);
                    UiUtils.showError('ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
                } finally {
                    analyzeBtn.disabled = false;
                    analyzeBtn.textContent = 'ğŸ“Š AI ë°ì´í„° ë¶„ì„';
                    streamingIndicator.style.display = 'none';
                }
            }

            function displayBasicStats() {
                const statsGrid = document.getElementById('statsGrid');
                const headers = currentData.length > 0 ? Object.keys(currentData[0]) : [];
                
                statsGrid.innerHTML = `
                    <div class="stat-card">
                        <div class="stat-number">${currentData.length}</div>
                        <div class="stat-label">ë°ì´í„° í–‰</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${headers.length}</div>
                        <div class="stat-label">ì»¬ëŸ¼ ìˆ˜</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${(currentData.length * headers.length)}</div>
                        <div class="stat-label">ì „ì²´ ë°ì´í„° í¬ì¸íŠ¸</div>
                    </div>
                `;
            }

            function displayInsights(text) {
                const container = document.getElementById('insightsContainer');
                
                const sections = text.split(/\*\*/).filter(s => s.trim());
                
                let html = '';
                for (let i = 0; i < sections.length; i += 2) {
                    if (sections[i + 1]) {
                        const title = sections[i].replace(/:/g, '').trim();
                        const content = sections[i + 1].trim();
                        
                        const icons = ['ğŸ“Š', 'ğŸ’¡', 'ğŸ“ˆ', 'ğŸ’¼'];
                        const icon = icons[Math.floor(i / 2) % icons.length];
                        
                        html += `
                            <div class="insight-card">
                                <h4>${icon} ${title}</h4>
                                <div class="insight-content">${content.replace(/\n/g, '<br>')}</div>
                            </div>
                        `;
                    }
                }
                
                container.innerHTML = html;
            }

            function clearData() {
                currentData = null;
                dataType = null;
                document.getElementById('fileInput').value = '';
                document.getElementById('dataInput').value = '';
                document.getElementById('dataPreview').classList.remove('show');
                document.getElementById('fileInfo').classList.remove('show');
                document.getElementById('analysisResults').style.display = 'none';
                UiUtils.hideError();
            }

            function fillSampleData(type) {
                const samples = {
                    'sales': `product,quantity,price,date
Laptop,5,1200000,2024-01-15
Mouse,20,25000,2024-01-15
Keyboard,15,75000,2024-01-16
Monitor,8,350000,2024-01-16
Laptop,3,1200000,2024-01-17
Headset,12,85000,2024-01-17`,
                    
                    'students': `name,math,english,science,grade
Alice,85,92,88,A
Bob,78,85,82,B
Charlie,92,88,95,A
David,65,70,68,C
Eve,88,90,87,A
Frank,72,75,70,B`,
                    
                    'products': `product,stock,reorder_point,category,supplier
Laptop,45,20,Electronics,Samsung
Mouse,120,50,Accessories,Logitech
Keyboard,85,30,Accessories,Logitech
Monitor,32,15,Electronics,LG
Headset,68,25,Accessories,Sony
Tablet,28,20,Electronics,Apple`
                };
                
                document.getElementById('dataInput').value = samples[type] || samples['sales'];
                parseCSV(samples[type]);
            }
        </script>
    </th:block>
</body>
</html>