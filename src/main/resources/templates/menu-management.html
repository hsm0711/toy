<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout}">
<head>
    <title>ë©”ë‰´ ê´€ë¦¬</title>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <th:block layout:fragment="extra-css">
        <link rel="stylesheet" th:href="@{/css/tool-page.css}">
        <style>
            .drag-handle {
                cursor: grab;
                text-align: center;
                color: #adb5bd;
                font-size: 1.2rem;
                padding-top: 1rem;
                padding-bottom: 1rem;
            }
            .sortable-ghost {
                opacity: 0.4;
                background: #e9ecef;
            }
            .sortable-chosen {
                cursor: grabbing;
            }
            .action-bar {
                background: white;
                padding: 1.5rem;
                border-radius: 8px;
                margin-bottom: 1.5rem;
                box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                display: flex;
                justify-content: space-between;
                align-items: center;
            }

            .menu-table {
                background: white;
                border-radius: 8px;
                box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                overflow: hidden;
            }

            table {
                width: 100%;
                border-collapse: collapse;
            }

            thead {
                background: #f8f9fa;
            }

            th {
                padding: 1rem;
                text-align: left;
                color: #495057;
                font-weight: 600;
                border-bottom: 2px solid #dee2e6;
            }

            td {
                padding: 1rem;
                border-bottom: 1px solid #dee2e6;
            }

            tbody tr:hover {
                background: #f8f9fa;
            }

            tbody tr:last-child td {
                border-bottom: none;
            }

            .status-badge {
                padding: 0.25rem 0.75rem;
                border-radius: 4px;
                font-size: 0.875rem;
                font-weight: 500;
            }

            .status-active {
                background: #d4edda;
                color: #155724;
            }

            .status-inactive {
                background: #f8d7da;
                color: #721c24;
            }

            .modal {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                z-index: 1000;
            }

            .modal-content {
                background: white;
                border-radius: 8px;
                max-width: 600px;
                margin: 80px auto;
                padding: 2rem;
                box-shadow: 0 4px 6px rgba(0,0,0,0.1);
                max-height: 85vh;
                overflow-y: auto;
            }

            .modal-header {
                margin-bottom: 1.5rem;
            }

            .modal-header h2 {
                color: #212529;
                margin: 0;
            }

            .form-group {
                margin-bottom: 1.5rem;
            }

            .form-group label {
                display: block;
                margin-bottom: 0.5rem;
                color: #495057;
                font-size: 0.875rem;
                font-weight: 500;
            }

            .form-control {
                width: 100%;
                padding: 0.75rem;
                border: 1px solid #ced4da;
                border-radius: 4px;
                font-size: 1rem;
            }

            .form-control:focus {
                outline: none;
                border-color: #667eea;
                box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            }

            .checkbox-wrapper {
                display: flex;
                align-items: center;
                gap: 0.5rem;
            }

            .checkbox-wrapper input[type="checkbox"] {
                width: 18px;
                height: 18px;
                cursor: pointer;
            }

            .modal-actions {
                display: flex;
                gap: 0.75rem;
                justify-content: flex-end;
                margin-top: 1.5rem;
            }

            .loading {
                text-align: center;
                padding: 3rem;
                color: #6c757d;
            }

            .empty-state {
                text-align: center;
                padding: 3rem;
                color: #6c757d;
            }

            .toast {
                position: fixed;
                top: 20px;
                right: 20px;
                background: #28a745;
                color: white;
                padding: 1rem 1.5rem;
                border-radius: 6px;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
                z-index: 2000;
                display: none;
            }

            .toast.error {
                background: #dc3545;
            }

            .actions {
                display: flex;
                gap: 0.5rem;
            }

            .icon-btn {
                background: none;
                border: none;
                color: #667eea;
                cursor: pointer;
                font-size: 1.25rem;
                padding: 0.25rem;
                transition: color 0.2s;
            }

            .icon-btn:hover {
                color: #5568d3;
            }

            .icon-btn.danger {
                color: #dc3545;
            }

            .icon-btn.danger:hover {
                color: #c82333;
            }

            /* ì•„ì´ì½˜ ì¶”ì²œ ìŠ¤íƒ€ì¼ */
            .icon-suggestions-container {
                position: relative;
            }

            .icon-suggestions {
                display: flex;
                flex-wrap: wrap;
                gap: 0.5rem;
                margin-top: 0.5rem;
                padding: 1rem;
                background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
                border-radius: 8px;
                min-height: 60px;
                border: 2px dashed #dee2e6;
                transition: all 0.3s ease;
            }

            .icon-suggestions.loading {
                display: flex;
                justify-content: center;
                align-items: center;
                min-height: 80px;
            }

            .icon-suggestions.has-items {
                border-color: #667eea;
                border-style: solid;
            }

            .icon-suggestion-item {
                display: inline-flex;
                flex-direction: column;
                align-items: center;
                gap: 0.25rem;
                padding: 0.6rem 0.8rem;
                background: white;
                border: 2px solid #dee2e6;
                border-radius: 8px;
                cursor: pointer;
                transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
                font-size: 0.85rem;
                box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            }

            .icon-suggestion-item:hover {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                border-color: #667eea;
                transform: translateY(-3px) scale(1.05);
                box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
            }

            .icon-suggestion-item.selected {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                border-color: #667eea;
                transform: scale(1.05);
                box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2);
            }

            .icon-suggestion-item .emoji {
                font-size: 1.8rem;
                line-height: 1;
            }

            .icon-suggestion-item .label {
                font-size: 0.7rem;
                opacity: 0.8;
                text-align: center;
            }

            .icon-suggestions.empty {
                display: none;
            }

            .helper-text {
                font-size: 0.75rem;
                color: #6c757d;
                margin-top: 0.25rem;
                display: flex;
                align-items: center;
                gap: 0.5rem;
            }

            .ai-badge {
                display: inline-flex;
                align-items: center;
                gap: 0.25rem;
                padding: 0.15rem 0.4rem;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                border-radius: 10px;
                font-size: 0.7rem;
                font-weight: 600;
            }

            .loading-spinner {
                width: 30px;
                height: 30px;
                border: 3px solid #f3f3f3;
                border-top: 3px solid #667eea;
                border-radius: 50%;
                animation: spin 1s linear infinite;
            }

            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }

            .suggestion-placeholder {
                text-align: center;
                color: #6c757d;
                font-size: 0.9rem;
                padding: 1rem;
            }

            .refresh-btn {
                display: inline-flex;
                align-items: center;
                gap: 0.25rem;
                padding: 0.4rem 0.8rem;
                background: #667eea;
                color: white;
                border: none;
                border-radius: 6px;
                cursor: pointer;
                font-size: 0.8rem;
                transition: all 0.2s;
                margin-top: 0.5rem;
            }

            .refresh-btn:hover {
                background: #5568d3;
                transform: translateY(-2px);
            }

            .refresh-btn:disabled {
                opacity: 0.5;
                cursor: not-allowed;
            }
        </style>
    </th:block>
</head>
<body>
    <div layout:fragment="content">
        <div class="tool-container">
            <div class="page-header">
                <h2>ğŸ¯ ë©”ë‰´ ê´€ë¦¬</h2>
                <p class="description">ì• í”Œë¦¬ì¼€ì´ì…˜ì˜ ë©”ë‰´ë¥¼ ìƒì„±, ìˆ˜ì •, ì‚­ì œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
            </div>

            <div class="action-bar">
                <button class="btn btn-primary" onclick="showCreateModal()">
                    â• ìƒˆ ë©”ë‰´ ì¶”ê°€
                </button>
                <button class="btn btn-secondary" onclick="window.location.href='/'">
                    ğŸ  í™ˆìœ¼ë¡œ
                </button>
            </div>

            <div class="menu-table">
                <table>
                    <thead>
                        <tr>
                            <th style="width: 50px;"></th>
                            <th style="width: 50px;">ID</th>
                            <th>ë©”ë‰´ëª…</th>
                            <th>ê²½ë¡œ</th>
                            <th style="width: 80px;">ìˆœì„œ</th>
                            <th style="width: 100px;">ìƒíƒœ</th>
                            <th style="width: 150px;">ì‘ì—…</th>
                        </tr>
                    </thead>
                    <tbody id="menuTableBody">
                        <tr>
                            <td colspan="7" class="loading">ë©”ë‰´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- ë©”ë‰´ ìƒì„±/ìˆ˜ì • ëª¨ë‹¬ -->
        <div id="menuModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 id="modalTitle">â• ë©”ë‰´ ì¶”ê°€</h2>
                </div>
                <form id="menuForm">
                    <input type="hidden" id="menuId">
                    
                    <div class="form-group">
                        <label for="menuName">ë©”ë‰´ëª… *</label>
                        <input type="text" id="menuName" class="form-control" required>
                    </div>

                    <div class="form-group">
                        <label for="menuPath">ê²½ë¡œ *</label>
                        <input type="text" id="menuPath" class="form-control" placeholder="/example" required>
                    </div>

                    <div class="form-group">
                        <label for="menuIcon">
                            ì•„ì´ì½˜ (ì„ íƒ)
                            <span class="ai-badge">âœ¨ AI ì¶”ì²œ</span>
                        </label>
                        <div class="d-flex align-items-center gap-2">
                            <input type="text" id="menuIcon" class="form-control" placeholder="ğŸ”§" readonly>
                            <button type="button" id="getSuggestionBtn" class="btn btn-primary" onclick="suggestIconWithAI()">
                                ì•„ì´ì½˜ ì¶”ì²œë°›ê¸°
                            </button>
                        </div>
                        <div class="helper-text">
                            <span>ë©”ë‰´ëª…ì„ ì…ë ¥í•˜ê³  'ì•„ì´ì½˜ ì¶”ì²œë°›ê¸°' ë²„íŠ¼ì„ í´ë¦­í•˜ë©´ AIê°€ ì í•©í•œ ì•„ì´ì½˜ì„ ì¶”ì²œí•©ë‹ˆë‹¤</span>
                        </div>
                        <div class="icon-suggestions-container">
                            <div id="iconSuggestions" class="icon-suggestions empty">
                                <div class="suggestion-placeholder">
                                    ğŸ’¡ ë©”ë‰´ëª…ì„ ì…ë ¥í•˜ë©´ AIê°€ ì•„ì´ì½˜ì„ ì¶”ì²œí•©ë‹ˆë‹¤
                                </div>
                            </div>
                            <button type="button" id="refreshBtn" class="refresh-btn" onclick="suggestIconWithAI()" style="display: none;">
                                ğŸ”„ ë‹¤ë¥¸ ì•„ì´ì½˜ ì¶”ì²œë°›ê¸°
                            </button>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="displayOrder">í‘œì‹œ ìˆœì„œ *</label>
                        <input type="number" id="displayOrder" class="form-control" value="0" required>
                    </div>

                    <div class="form-group">
                        <div class="checkbox-wrapper">
                            <input type="checkbox" id="isActive" checked>
                            <label for="isActive">í™œì„±í™”</label>
                        </div>
                    </div>

                    <div class="modal-actions">
                        <button type="button" class="btn btn-secondary" onclick="closeModal()">ì·¨ì†Œ</button>
                        <button type="submit" class="btn btn-primary">ì €ì¥</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- í† ìŠ¤íŠ¸ íŒì—… -->
        <div id="toast" class="toast"></div>
    </div>

    <th:block layout:fragment="extra-js">
        <script>
            let menus = [];
            let editingMenuId = null;
            let debounceTimer = null;
            let lastMenuName = '';
            let sortable = null;

            window.onload = function() {
                loadMenus();
            };

            async function loadMenus() {
                try {
                    const response = await fetch('/mngt/menu/api/list');
                    menus = await response.json();
                    renderMenuTable();
                    initSortable();
                } catch (error) {
                    console.error('ë©”ë‰´ ë¡œë“œ ì‹¤íŒ¨:', error);
                    showToast('ë©”ë‰´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
                }
            }

            function renderMenuTable() {
                const tbody = document.getElementById('menuTableBody');
                
                if (menus.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="7" class="empty-state">
                                ë“±ë¡ëœ ë©”ë‰´ê°€ ì—†ìŠµë‹ˆë‹¤.<br>
                                <button class="btn btn-primary btn-sm" onclick="showCreateModal()" style="margin-top: 10px;">
                                    ì²« ë©”ë‰´ ì¶”ê°€í•˜ê¸°
                                </button>
                            </td>
                        </tr>
                    `;
                    return;
                }

                tbody.innerHTML = menus.map(menu => `
                    <tr data-menu-id="${menu.id}">
                        <td class="drag-handle">â˜°</td>
                        <td>${menu.id}</td>
                        <td>${menu.icon ? menu.icon + ' ' : ''}${menu.name}</td>
                        <td><code>${menu.path}</code></td>
                        <td>${menu.displayOrder}</td>
                        <td>
                            <span class="status-badge ${menu.isActive ? 'status-active' : 'status-inactive'}">
                                ${menu.isActive ? 'í™œì„±' : 'ë¹„í™œì„±'}
                            </span>
                        </td>
                        <td>
                            <div class="actions">
                                <button class="icon-btn" onclick="toggleMenu(${menu.id})" title="${menu.isActive ? 'ë¹„í™œì„±í™”' : 'í™œì„±í™”'}">
                                    ${menu.isActive ? 'ğŸ‘ï¸' : 'ğŸ‘ï¸â€ğŸ—¨ï¸'}
                                </button>
                                <button class="icon-btn" onclick="showEditModal(${menu.id})" title="ìˆ˜ì •">
                                    âœï¸
                                </button>
                                <button class="icon-btn danger" onclick="deleteMenu(${menu.id})" title="ì‚­ì œ">
                                    ğŸ—‘ï¸
                                </button>
                            </div>
                        </td>
                    </tr>
                `).join('');
            }

            function showCreateModal() {
                editingMenuId = null;
                document.getElementById('modalTitle').textContent = 'â• ë©”ë‰´ ì¶”ê°€';
                document.getElementById('menuForm').reset();
                document.getElementById('menuId').value = '';
                document.getElementById('isActive').checked = true;
                document.getElementById('menuIcon').value = ''; // ì•„ì´ì½˜ ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
                resetIconSuggestions();
                document.getElementById('menuModal').style.display = 'block';
            }

            function showEditModal(id) {
                editingMenuId = id;
                const menu = menus.find(m => m.id === id);
                
                if (!menu) return;

                document.getElementById('modalTitle').textContent = 'âœï¸ ë©”ë‰´ ìˆ˜ì •';
                document.getElementById('menuId').value = menu.id;
                document.getElementById('menuName').value = menu.name;
                document.getElementById('menuPath').value = menu.path;
                document.getElementById('menuIcon').value = menu.icon || '';
                document.getElementById('displayOrder').value = menu.displayOrder;
                document.getElementById('isActive').checked = menu.isActive;
                document.getElementById('menuModal').style.display = 'block';
                
                lastMenuName = menu.name; // Keep track of current name for refresh button
                // When editing, if there's an icon, show refresh button
                const refreshBtn = document.getElementById('refreshBtn');
                const getSuggestionBtn = document.getElementById('getSuggestionBtn');

                if (menu.icon) {
                    refreshBtn.style.display = 'inline-flex';
                    getSuggestionBtn.style.display = 'none'; // Hide initial suggestion button
                } else {
                    refreshBtn.style.display = 'none';
                    getSuggestionBtn.style.display = 'inline-flex';
                }
                document.getElementById('getSuggestionBtn').textContent = 'ì•„ì´ì½˜ ì¶”ì²œë°›ê¸°';
            }

            function closeModal() {
                document.getElementById('menuModal').style.display = 'none';
                lastMenuName = '';
                document.getElementById('getSuggestionBtn').textContent = 'ì•„ì´ì½˜ ì¶”ì²œë°›ê¸°';
                document.getElementById('refreshBtn').style.display = 'none';
                document.getElementById('getSuggestionBtn').style.display = 'inline-flex';
            }

            function resetIconSuggestions() {
                const suggestionsDiv = document.getElementById('iconSuggestions');
                const getSuggestionBtn = document.getElementById('getSuggestionBtn');
                const refreshBtn = document.getElementById('refreshBtn');

                suggestionsDiv.innerHTML = '<div class="suggestion-placeholder">ğŸ’¡ ë©”ë‰´ëª…ì„ ì…ë ¥í•˜ê³  \'ì•„ì´ì½˜ ì¶”ì²œë°›ê¸°\' ë²„íŠ¼ì„ í´ë¦­í•˜ë©´ AIê°€ ì•„ì´ì½˜ì„ ì¶”ì²œí•©ë‹ˆë‹¤</div>';
                suggestionsDiv.classList.add('empty');
                suggestionsDiv.classList.remove('has-items', 'loading');
                
                getSuggestionBtn.style.display = 'inline-flex';
                getSuggestionBtn.textContent = 'ì•„ì´ì½˜ ì¶”ì²œë°›ê¸°';
                refreshBtn.style.display = 'none';
            }

            // ë””ë°”ìš´ìŠ¤ ì²˜ë¦¬ (ì´ì œ ì‚¬ìš©ë˜ì§€ ì•ŠìŒ, ì œê±° ì˜ˆì •)
            // function debouncedSuggestIcon() {
            //     clearTimeout(debounceTimer);
            //     const menuName = document.getElementById('menuName').value.trim();
                
            //     if (!menuName) {
            //         resetIconSuggestions();
            //         return;
            //     }
                
            //     debounceTimer = setTimeout(() => {
            //         if (menuName !== lastMenuName) {
            //             lastMenuName = menuName;
            //             suggestIconWithAI();
            //         }
            //     }, 800); // 0.8ì´ˆ ëŒ€ê¸°
            // }

            // AI ê¸°ë°˜ ì•„ì´ì½˜ ì¶”ì²œ
            async function suggestIconWithAI() {
                const menuName = document.getElementById('menuName').value.trim();
                
                if (!menuName) {
                    showToast('ë©”ë‰´ëª…ì„ ì…ë ¥í•˜ì„¸ìš”.', 'error');
                    resetIconSuggestions();
                    return;
                }
                
                const suggestionsDiv = document.getElementById('iconSuggestions');
                const getSuggestionBtn = document.getElementById('getSuggestionBtn');
                const refreshBtn = document.getElementById('refreshBtn');

                let targetButton = event.target; // Determine which button triggered the call

                // ë¡œë”© ìƒíƒœ
                suggestionsDiv.classList.remove('empty', 'has-items');
                suggestionsDiv.classList.add('loading');
                suggestionsDiv.innerHTML = '<div class="loading-spinner"></div>';
                
                targetButton.disabled = true;
                const originalButtonText = targetButton.textContent;
                targetButton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> ì¶”ì²œ ì¤‘...';
                
                try {
                    const response = await fetch('/mngt/menu/api/suggest-icon', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ menuName: menuName })
                    });

                    const data = await response.json();
                    
                    if (!response.ok || !data.success) {
                        throw new Error(data.message || 'AI ì¶”ì²œ API í˜¸ì¶œ ì‹¤íŒ¨');
                    }
                    
                    // resultëŠ” JSON ë¬¸ìì—´ì´ë¯€ë¡œ ë‹¤ì‹œ íŒŒì‹±
                    const iconData = JSON.parse(data.result);
                    
                    if (!iconData.icons || !Array.isArray(iconData.icons)) {
                        throw new Error('Invalid icon data format');
                    }
                    
                    // ì•„ì´ì½˜ í‘œì‹œ
                    displayIconSuggestions(iconData.icons);
                    showToast('ì•„ì´ì½˜ì´ ì„±ê³µì ìœ¼ë¡œ ì¶”ì²œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                    
                } catch (error) {
                    console.error('AI ì¶”ì²œ ì‹¤íŒ¨:', error);
                    showToast(error.message, 'error');
                    
                    // í´ë°±: ê¸°ë³¸ ì•„ì´ì½˜ ì¶”ì²œ
                    const fallbackIcons = getFallbackIcons(menuName);
                    displayIconSuggestions(fallbackIcons);
                } finally {
                    targetButton.disabled = false;
                    targetButton.innerHTML = originalButtonText;

                    // Hide initial suggestion button, show refresh button
                    getSuggestionBtn.style.display = 'none';
                    refreshBtn.style.display = 'inline-flex';
                }
            }

            // ì•„ì´ì½˜ í‘œì‹œ
            function displayIconSuggestions(icons) {
                const suggestionsDiv = document.getElementById('iconSuggestions');
                
                if (!icons || icons.length === 0) {
                    suggestionsDiv.innerHTML = '<div class="suggestion-placeholder">ì¶”ì²œí•  ì•„ì´ì½˜ì´ ì—†ìŠµë‹ˆë‹¤</div>';
                    suggestionsDiv.classList.add('empty');
                    suggestionsDiv.classList.remove('loading', 'has-items');
                    return;
                }
                
                suggestionsDiv.classList.remove('empty', 'loading');
                suggestionsDiv.classList.add('has-items');
                
                suggestionsDiv.innerHTML = icons.map(icon => `
                    <div class="icon-suggestion-item" onclick="selectIcon('${icon.emoji}')" title="${icon.description || ''}">
                        <span class="emoji">${icon.emoji}</span>
                        <span class="label">${icon.description || ''}</span>
                    </div>
                `).join('');
            }

            // í´ë°± ì•„ì´ì½˜ (AI ì‹¤íŒ¨ ì‹œ)
            function getFallbackIcons(menuName) {
                const name = menuName.toLowerCase();
                
                // í‚¤ì›Œë“œ ê¸°ë°˜ ê¸°ë³¸ ë§¤í•‘
                const keywordMap = {
                    'pdf': [{emoji: 'ğŸ“„', description: 'PDF'}, {emoji: 'ğŸ“‘', description: 'ë¬¸ì„œ'}, {emoji: 'ğŸ—‚ï¸', description: 'íŒŒì¼'}],
                    'ë³‘í•©': [{emoji: 'ğŸ”—', description: 'ì—°ê²°'}, {emoji: 'ğŸ“‘', description: 'ë³‘í•©'}, {emoji: 'ğŸ“‹', description: 'í†µí•©'}],
                    'ì •ê·œì‹': [{emoji: 'ğŸ”', description: 'ê²€ìƒ‰'}, {emoji: 'ğŸ¯', description: 'ì •í™•'}, {emoji: 'ğŸ”', description: 'ì°¾ê¸°'}],
                    'ì½”ë“œ': [{emoji: 'ğŸ’»', description: 'ì½”ë”©'}, {emoji: 'âŒ¨ï¸', description: 'ê°œë°œ'}, {emoji: 'ğŸ–¥ï¸', description: 'ì»´í“¨í„°'}],
                    'uuid': [{emoji: 'ğŸ”‘', description: 'í‚¤'}, {emoji: 'ğŸ²', description: 'ëœë¤'}, {emoji: 'ğŸ†”', description: 'ID'}],
                    'ë³€í™˜': [{emoji: 'ğŸ”„', description: 'ë³€í™˜'}, {emoji: 'â™»ï¸', description: 'ì¬í™œìš©'}, {emoji: 'â†”ï¸', description: 'êµí™˜'}],
                    'ì‹œê°„': [{emoji: 'â°', description: 'ì‹œê³„'}, {emoji: 'ğŸ•', description: 'ì‹œê°„'}, {emoji: 'â±ï¸', description: 'íƒ€ì´ë¨¸'}],
                    'ip': [{emoji: 'ğŸŒ', description: 'ë„¤íŠ¸ì›Œí¬'}, {emoji: 'ğŸ”Œ', description: 'ì—°ê²°'}, {emoji: 'ğŸ’»', description: 'ì»´í“¨í„°'}],
                    'ê´€ë¦¬': [{emoji: 'âš™ï¸', description: 'ì„¤ì •'}, {emoji: 'ğŸ› ï¸', description: 'ë„êµ¬'}, {emoji: 'ğŸ“Š', description: 'ê´€ë¦¬'}],
                };
                
                for (const [keyword, icons] of Object.entries(keywordMap)) {
                    if (name.includes(keyword)) {
                        return icons;
                    }
                }
                
                // ê¸°ë³¸ ì•„ì´ì½˜
                return [
                    {emoji: 'ğŸ”§', description: 'ë„êµ¬'},
                    {emoji: 'âš™ï¸', description: 'ì„¤ì •'},
                    {emoji: 'ğŸ“‹', description: 'ëª©ë¡'},
                    {emoji: 'ğŸ¯', description: 'íƒ€ê²Ÿ'},
                    {emoji: 'âœ¨', description: 'íŠ¹ë³„'},
                    {emoji: 'ğŸš€', description: 'ë¹ ë¥¸'},
                    {emoji: 'ğŸ“Š', description: 'ë°ì´í„°'},
                    {emoji: 'ğŸ¨', description: 'ë””ìì¸'}
                ];
            }

            // ì•„ì´ì½˜ ì„ íƒ
            function selectIcon(icon) {
                document.getElementById('menuIcon').value = icon;
                
                // ì„ íƒëœ ì•„ì´ì½˜ í•˜ì´ë¼ì´íŠ¸
                document.querySelectorAll('.icon-suggestion-item').forEach(item => {
                    item.classList.remove('selected');
                });
                event.target.closest('.icon-suggestion-item').classList.add('selected');
            }

            function initSortable() {
                const tbody = document.getElementById('menuTableBody');
                if (sortable) {
                    sortable.destroy();
                }
                
                sortable = new Sortable(tbody, {
                    handle: '.drag-handle',
                    animation: 150,
                    ghostClass: 'sortable-ghost',
                    chosenClass: 'sortable-chosen',
                    onEnd: function (evt) {
                        const menuIds = Array.from(tbody.querySelectorAll('tr')).map(row => row.dataset.menuId);
                        saveMenuOrder(menuIds);
                    }
                });
            }

            async function saveMenuOrder(menuIds) {
                try {
                    const response = await fetch('/mngt/menu/api/update-order', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(menuIds)
                    });

                    const result = await response.json();

                    if (result.success) {
                        showToast(result.message);
                        loadMenus(); // ìˆœì„œê°€ ì¦‰ì‹œ ë°˜ì˜ë˜ë„ë¡ ë‹¤ì‹œ ë¡œë“œ
                    } else {
                        showToast(result.message, 'error');
                    }
                } catch (error) {
                    console.error('ë©”ë‰´ ìˆœì„œ ì €ì¥ ì‹¤íŒ¨:', error);
                    showToast('ë©”ë‰´ ìˆœì„œ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
                }
            }

            document.getElementById('menuForm').addEventListener('submit', async function(e) {
                e.preventDefault();

                const menuData = {
                    name: document.getElementById('menuName').value,
                    path: document.getElementById('menuPath').value,
                    icon: document.getElementById('menuIcon').value || null,
                    displayOrder: parseInt(document.getElementById('displayOrder').value),
                    isActive: document.getElementById('isActive').checked
                };

                try {
                    let response;
                    
                    if (editingMenuId) {
                        response = await fetch(`/mngt/menu/api/update/${editingMenuId}`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(menuData)
                        });
                    } else {
                        response = await fetch('/mngt/menu/api/create', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(menuData)
                        });
                    }

                    const result = await response.json();

                    if (result.success) {
                        showToast(result.message);
                        closeModal();
                        loadMenus();
                    } else {
                        showToast(result.message, 'error');
                    }
                } catch (error) {
                    console.error('ë©”ë‰´ ì €ì¥ ì‹¤íŒ¨:', error);
                    showToast('ë©”ë‰´ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
                }
            });

            async function toggleMenu(id) {
                try {
                    const response = await fetch(`/mngt/menu/api/toggle/${id}`, {
                        method: 'PATCH'
                    });

                    const result = await response.json();

                    if (result.success) {
                        showToast(result.message);
                        loadMenus();
                    } else {
                        showToast(result.message, 'error');
                    }
                } catch (error) {
                    console.error('ë©”ë‰´ í† ê¸€ ì‹¤íŒ¨:', error);
                    showToast('ë©”ë‰´ ìƒíƒœ ë³€ê²½ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
                }
            }

            async function deleteMenu(id) {
                if (!confirm('ì •ë§ë¡œ ì´ ë©”ë‰´ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                    return;
                }

                try {
                    const response = await fetch(`/mngt/menu/api/delete/${id}`, {
                        method: 'DELETE'
                    });

                    const result = await response.json();

                    if (result.success) {
                        showToast(result.message);
                        loadMenus();
                    } else {
                        showToast(result.message, 'error');
                    }
                } catch (error) {
                    console.error('ë©”ë‰´ ì‚­ì œ ì‹¤íŒ¨:', error);
                    showToast('ë©”ë‰´ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
                }
            }

            function showToast(message, type = 'success') {
                const toast = document.getElementById('toast');
                toast.textContent = message;
                toast.className = 'toast ' + (type === 'error' ? 'error' : '');
                toast.style.display = 'block';

                setTimeout(() => {
                    toast.style.display = 'none';
                }, 3000);
            }

            const modal = document.getElementById('menuModal');
            let isMouseDownOnModal = false;

            modal.addEventListener('mousedown', function(event) {
                if (event.target === modal) {
                    isMouseDownOnModal = true;
                }
            });

            modal.addEventListener('mouseup', function(event) {
                if (event.target === modal && isMouseDownOnModal) {
                    closeModal();
                }
                isMouseDownOnModal = false;
            });
            
            // Prevent window.onclick from being used
            // window.onclick = function(event) {
            //     if (event.target === modal) {
            //         closeModal();
            //     }
            // }
        </script>
    </th:block>
</body>
</html>