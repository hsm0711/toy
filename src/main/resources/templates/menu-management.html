<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout}">
<head>
    <title>ë©”ë‰´ ê´€ë¦¬</title>
    <th:block layout:fragment="extra-css">
        <link rel="stylesheet" th:href="@{/css/tool-page.css}">
        <style>
            .action-bar {
                background: white;
                padding: 1.5rem;
                border-radius: 8px;
                margin-bottom: 1.5rem;
                box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                display: flex;
                justify-content: space-between;
                align-items: center;
            }

            .menu-table {
                background: white;
                border-radius: 8px;
                box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                overflow: hidden;
            }

            table {
                width: 100%;
                border-collapse: collapse;
            }

            thead {
                background: #f8f9fa;
            }

            th {
                padding: 1rem;
                text-align: left;
                color: #495057;
                font-weight: 600;
                border-bottom: 2px solid #dee2e6;
            }

            td {
                padding: 1rem;
                border-bottom: 1px solid #dee2e6;
            }

            tbody tr:hover {
                background: #f8f9fa;
            }

            tbody tr:last-child td {
                border-bottom: none;
            }

            .status-badge {
                padding: 0.25rem 0.75rem;
                border-radius: 4px;
                font-size: 0.875rem;
                font-weight: 500;
            }

            .status-active {
                background: #d4edda;
                color: #155724;
            }

            .status-inactive {
                background: #f8d7da;
                color: #721c24;
            }

            .modal {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                z-index: 1000;
            }

            .modal-content {
                background: white;
                border-radius: 8px;
                max-width: 500px;
                margin: 100px auto;
                padding: 2rem;
                box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            }

            .modal-header {
                margin-bottom: 1.5rem;
            }

            .modal-header h2 {
                color: #212529;
                margin: 0;
            }

            .form-group {
                margin-bottom: 1.5rem;
            }

            .form-group label {
                display: block;
                margin-bottom: 0.5rem;
                color: #495057;
                font-size: 0.875rem;
                font-weight: 500;
            }

            .form-control {
                width: 100%;
                padding: 0.75rem;
                border: 1px solid #ced4da;
                border-radius: 4px;
                font-size: 1rem;
            }

            .form-control:focus {
                outline: none;
                border-color: #667eea;
                box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            }

            .checkbox-wrapper {
                display: flex;
                align-items: center;
                gap: 0.5rem;
            }

            .checkbox-wrapper input[type="checkbox"] {
                width: 18px;
                height: 18px;
                cursor: pointer;
            }

            .modal-actions {
                display: flex;
                gap: 0.75rem;
                justify-content: flex-end;
                margin-top: 1.5rem;
            }

            .loading {
                text-align: center;
                padding: 3rem;
                color: #6c757d;
            }

            .empty-state {
                text-align: center;
                padding: 3rem;
                color: #6c757d;
            }

            .toast {
                position: fixed;
                top: 20px;
                right: 20px;
                background: #28a745;
                color: white;
                padding: 1rem 1.5rem;
                border-radius: 6px;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
                z-index: 2000;
                display: none;
            }

            .toast.error {
                background: #dc3545;
            }

            .actions {
                display: flex;
                gap: 0.5rem;
            }

            .icon-btn {
                background: none;
                border: none;
                color: #667eea;
                cursor: pointer;
                font-size: 1.25rem;
                padding: 0.25rem;
                transition: color 0.2s;
            }

            .icon-btn:hover {
                color: #5568d3;
            }

            .icon-btn.danger {
                color: #dc3545;
            }

            .icon-btn.danger:hover {
                color: #c82333;
            }
        </style>
    </th:block>
</head>
<body>
    <div layout:fragment="content">
        <div class="tool-container">
            <div class="page-header">
                <h2>ğŸ¯ ë©”ë‰´ ê´€ë¦¬</h2>
                <p class="description">ì• í”Œë¦¬ì¼€ì´ì…˜ì˜ ë©”ë‰´ë¥¼ ìƒì„±, ìˆ˜ì •, ì‚­ì œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
            </div>

            <div class="action-bar">
                <button class="btn btn-primary" onclick="showCreateModal()">
                    â• ìƒˆ ë©”ë‰´ ì¶”ê°€
                </button>
                <button class="btn btn-secondary" onclick="window.location.href='/'">
                    ğŸ  í™ˆìœ¼ë¡œ
                </button>
            </div>

            <div class="menu-table">
                <table>
                    <thead>
                        <tr>
                            <th style="width: 50px;">ID</th>
                            <th>ë©”ë‰´ëª…</th>
                            <th>ê²½ë¡œ</th>
                            <th style="width: 80px;">ìˆœì„œ</th>
                            <th style="width: 100px;">ìƒíƒœ</th>
                            <th style="width: 150px;">ì‘ì—…</th>
                        </tr>
                    </thead>
                    <tbody id="menuTableBody">
                        <tr>
                            <td colspan="6" class="loading">ë©”ë‰´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- ë©”ë‰´ ìƒì„±/ìˆ˜ì • ëª¨ë‹¬ -->
        <div id="menuModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 id="modalTitle">â• ë©”ë‰´ ì¶”ê°€</h2>
                </div>
                <form id="menuForm">
                    <input type="hidden" id="menuId">
                    
                    <div class="form-group">
                        <label for="menuName">ë©”ë‰´ëª… *</label>
                        <input type="text" id="menuName" class="form-control" required>
                    </div>

                    <div class="form-group">
                        <label for="menuPath">ê²½ë¡œ *</label>
                        <input type="text" id="menuPath" class="form-control" placeholder="/example" required>
                    </div>

                    <div class="form-group">
                        <label for="menuIcon">ì•„ì´ì½˜ (ì„ íƒ)</label>
                        <input type="text" id="menuIcon" class="form-control" placeholder="ğŸ”§">
                    </div>

                    <div class="form-group">
                        <label for="displayOrder">í‘œì‹œ ìˆœì„œ *</label>
                        <input type="number" id="displayOrder" class="form-control" value="0" required>
                    </div>

                    <div class="form-group">
                        <div class="checkbox-wrapper">
                            <input type="checkbox" id="isActive" checked>
                            <label for="isActive">í™œì„±í™”</label>
                        </div>
                    </div>

                    <div class="modal-actions">
                        <button type="button" class="btn btn-secondary" onclick="closeModal()">ì·¨ì†Œ</button>
                        <button type="submit" class="btn btn-primary">ì €ì¥</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- í† ìŠ¤íŠ¸ íŒì—… -->
        <div id="toast" class="toast"></div>
    </div>

    <th:block layout:fragment="extra-js">
        <script>
            let menus = [];
            let editingMenuId = null;

            window.onload = function() {
                loadMenus();
            };

            async function loadMenus() {
                try {
                    const response = await fetch('/mngt/menu/api/list');
                    menus = await response.json();
                    renderMenuTable();
                } catch (error) {
                    console.error('ë©”ë‰´ ë¡œë“œ ì‹¤íŒ¨:', error);
                    showToast('ë©”ë‰´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
                }
            }

            function renderMenuTable() {
                const tbody = document.getElementById('menuTableBody');
                
                if (menus.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="6" class="empty-state">
                                ë“±ë¡ëœ ë©”ë‰´ê°€ ì—†ìŠµë‹ˆë‹¤.<br>
                                <button class="btn btn-primary btn-sm" onclick="showCreateModal()" style="margin-top: 10px;">
                                    ì²« ë©”ë‰´ ì¶”ê°€í•˜ê¸°
                                </button>
                            </td>
                        </tr>
                    `;
                    return;
                }

                tbody.innerHTML = menus.map(menu => `
                    <tr>
                        <td>${menu.id}</td>
                        <td>${menu.icon ? menu.icon + ' ' : ''}${menu.name}</td>
                        <td><code>${menu.path}</code></td>
                        <td>${menu.displayOrder}</td>
                        <td>
                            <span class="status-badge ${menu.isActive ? 'status-active' : 'status-inactive'}">
                                ${menu.isActive ? 'í™œì„±' : 'ë¹„í™œì„±'}
                            </span>
                        </td>
                        <td>
                            <div class="actions">
                                <button class="icon-btn" onclick="toggleMenu(${menu.id})" title="${menu.isActive ? 'ë¹„í™œì„±í™”' : 'í™œì„±í™”'}">
                                    ${menu.isActive ? 'ğŸ‘ï¸' : 'ğŸ‘ï¸â€ğŸ—¨ï¸'}
                                </button>
                                <button class="icon-btn" onclick="showEditModal(${menu.id})" title="ìˆ˜ì •">
                                    âœï¸
                                </button>
                                <button class="icon-btn danger" onclick="deleteMenu(${menu.id})" title="ì‚­ì œ">
                                    ğŸ—‘ï¸
                                </button>
                            </div>
                        </td>
                    </tr>
                `).join('');
            }

            function showCreateModal() {
                editingMenuId = null;
                document.getElementById('modalTitle').textContent = 'â• ë©”ë‰´ ì¶”ê°€';
                document.getElementById('menuForm').reset();
                document.getElementById('menuId').value = '';
                document.getElementById('isActive').checked = true;
                document.getElementById('menuModal').style.display = 'block';
            }

            function showEditModal(id) {
                editingMenuId = id;
                const menu = menus.find(m => m.id === id);
                
                if (!menu) return;

                document.getElementById('modalTitle').textContent = 'ë©”ë‰´ ìˆ˜ì •';
                document.getElementById('menuId').value = menu.id;
                document.getElementById('menuName').value = menu.name;
                document.getElementById('menuPath').value = menu.path;
                document.getElementById('menuIcon').value = menu.icon || '';
                document.getElementById('displayOrder').value = menu.displayOrder;
                document.getElementById('isActive').checked = menu.isActive;
                document.getElementById('menuModal').style.display = 'block';
            }

            function closeModal() {
                document.getElementById('menuModal').style.display = 'none';
            }

            document.getElementById('menuForm').addEventListener('submit', async function(e) {
                e.preventDefault();

                const menuData = {
                    name: document.getElementById('menuName').value,
                    path: document.getElementById('menuPath').value,
                    icon: document.getElementById('menuIcon').value || null,
                    displayOrder: parseInt(document.getElementById('displayOrder').value),
                    isActive: document.getElementById('isActive').checked
                };

                try {
                    let response;
                    
                    if (editingMenuId) {
                        response = await fetch(`/mngt/menu/api/update/${editingMenuId}`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(menuData)
                        });
                    } else {
                        response = await fetch('/mngt/menu/api/create', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(menuData)
                        });
                    }

                    const result = await response.json();

                    if (result.success) {
                        showToast(result.message);
                        closeModal();
                        loadMenus();
                    } else {
                        showToast(result.message, 'error');
                    }
                } catch (error) {
                    console.error('ë©”ë‰´ ì €ì¥ ì‹¤íŒ¨:', error);
                    showToast('ë©”ë‰´ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
                }
            });

            async function toggleMenu(id) {
                try {
                    const response = await fetch(`/mngt/menu/api/toggle/${id}`, {
                        method: 'PATCH'
                    });

                    const result = await response.json();

                    if (result.success) {
                        showToast(result.message);
                        loadMenus();
                    } else {
                        showToast(result.message, 'error');
                    }
                } catch (error) {
                    console.error('ë©”ë‰´ í† ê¸€ ì‹¤íŒ¨:', error);
                    showToast('ë©”ë‰´ ìƒíƒœ ë³€ê²½ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
                }
            }

            async function deleteMenu(id) {
                if (!confirm('ì •ë§ë¡œ ì´ ë©”ë‰´ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                    return;
                }

                try {
                    const response = await fetch(`/mngt/menu/api/delete/${id}`, {
                        method: 'DELETE'
                    });

                    const result = await response.json();

                    if (result.success) {
                        showToast(result.message);
                        loadMenus();
                    } else {
                        showToast(result.message, 'error');
                    }
                } catch (error) {
                    console.error('ë©”ë‰´ ì‚­ì œ ì‹¤íŒ¨:', error);
                    showToast('ë©”ë‰´ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
                }
            }

            function showToast(message, type = 'success') {
                const toast = document.getElementById('toast');
                toast.textContent = message;
                toast.className = 'toast ' + (type === 'error' ? 'error' : '');
                toast.style.display = 'block';

                setTimeout(() => {
                    toast.style.display = 'none';
                }, 3000);
            }

            window.onclick = function(event) {
                const modal = document.getElementById('menuModal');
                if (event.target === modal) {
                    closeModal();
                }
            }
        </script>
    </th:block>
</body>
</html>